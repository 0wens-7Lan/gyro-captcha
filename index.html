<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>æ‘‡ä¸€æ‘‡éªŒè¯ç </title>
    <style>
        /* CSS æ ·å¼ä¿æŒä¸å˜ */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f7f7f7;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            padding-top: 50px;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            padding: 10px 0;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            background-color: white;
            z-index: 10;
            border-bottom: 1px solid #eee;
        }

        .verification-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 400px;
            padding: 20px 15px;
            margin-top: 10px;
            box-sizing: border-box;
        }

        .prompt {
            text-align: center;
            padding-bottom: 20px;
        }

        .prompt h3 {
            color: #1a73e8;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .prompt p {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }

        .target-area {
            background-color: #ff5773;
            color: white;
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .target-area .label {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .target-area .value {
            font-size: 32px;
            font-weight: bold;
        }

        .target-tip {
            font-size: 12px;
            margin-top: 10px;
            opacity: 0.8;
        }

        .target-marker {
            position: absolute;
            bottom: -5px;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            transform: translateX(-50%);
            transition: left 0.5s ease;
        }

        .slider-container {
            position: relative;
            height: 30px;
            margin-bottom: 20px;
        }

        .slider-track {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            transform: translateY(-50%);
        }

        .slider-handle {
            position: absolute;
            top: 50%;
            width: 25px;
            height: 25px;
            background-color: #4a90e2;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }
        
        .arrow-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 20px;
            font-weight: bold;
        }

        .left-arrow {
            left: -30px;
        }

        .right-arrow {
            right: -30px;
        }

        .scale-ruler {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 5px;
            color: #999;
            font-size: 10px;
        }

        .current-position-box {
            border: 1px solid #ddd;
            background-color: #f0f0f0;
            border-radius: 6px;
            padding: 10px;
            margin-top: 30px;
            text-align: center;
            position: relative;
            font-size: 14px;
            color: #333;
        }

        .current-position-box .label {
            position: absolute;
            bottom: 100%;
            left: 10px;
            font-size: 12px;
            color: #666;
            padding-bottom: 5px;
        }

        .current-position-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a73e8;
        }

        .message {
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            min-height: 20px;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }
        
        #permissionButton {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        /* æ–°å¢ æ ¡å‡†æŒ‰é’® æ ·å¼ */
        #calibrateButton {
            background-color: #FFA500; /* æ©™è‰² */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
            display: none; /* åˆå§‹éšè— */
        }


        #permissionButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .nav-bar {
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            height: 50px; 
            background: #fff; 
            box-shadow: 0 -1px 3px rgba(0,0,0,0.1); 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            padding-bottom: env(safe-area-inset-bottom, 5px);
            z-index: 10;
        }
        .nav-bar span {
            font-size: 24px;
            color: #555;
            padding: 0 10px;
        }
    </style>
</head>
<body>

    <div class="header">ç¬¬ä¸€å…³ï¼šæ‘‡ä¸€æ‘‡éªŒè¯ç </div>

    <div class="verification-card">
        
        <button id="permissionButton">ç‚¹å‡»æˆæƒæ‘‡æ™ƒæ‰‹æœº</button>
        <button id="calibrateButton">æ‰‹æœºæ°´å¹³æ”¾ç½®åï¼Œç‚¹å‡»æ ¡å‡† (è®¾ä¸º 0.500)</button>

        <div class="prompt">
            <h3>éªŒè¯æ‚¨ä¸æ˜¯æœºå™¨äººğŸ¤–</h3>
            <p>å€¾æ–œæ‰‹æœºå·¦å³ç§»åŠ¨æ»‘å—è¿›è¡ŒéªŒè¯</p>
        </div>

        <div class="target-area">
            <div class="label">ç›®æ ‡ä½ç½®</div>
            <div class="value" id="targetValue">0.000</div>
            <div class="target-tip">å°†æ»‘å—ç§»åŠ¨åˆ°æ­¤ä½ç½®å¹¶ä¿æŒ3ç§’</div>
            <div class="target-marker" id="targetMarker"></div>
        </div>

        <div class="slider-container" id="sliderContainer">
            <div class="arrow-icon left-arrow">â†</div>
            <div class="slider-track"></div>
            <div class="slider-handle" id="sliderHandle"></div>
            <div class="arrow-icon right-arrow">â†’</div>
        </div>

        <div class="scale-ruler">
            <span>0.000</span>
            <span>0.250</span>
            <span>0.500</span>
            <span>0.750</span>
            <span>1.000</span>
        </div>

        <div class="current-position-box">
            <span class="label">å½“å‰ä½ç½®:</span>
            <div class="current-position-value" id="currentValue">0.000</div>
        </div>
        
        <div class="message" id="verificationMessage">è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æˆæƒ</div>
    </div>

    <div class="nav-bar">
        <span>&#x2329;</span>
        <span>&gt;</span>
        <span>&#x2302;</span>
        <span>&#x25A1;</span>
        <span>&#x2642;</span>
    </div>

    <script>
        const sliderContainer = document.getElementById('sliderContainer');
        const sliderHandle = document.getElementById('sliderHandle');
        const currentValueDisplay = document.getElementById('currentValue');
        const targetValueDisplay = document.getElementById('targetValue');
        const targetMarker = document.getElementById('targetMarker');
        const verificationMessage = document.getElementById('verificationMessage');
        const permissionButton = document.getElementById('permissionButton');
        const calibrateButton = document.getElementById('calibrateButton'); // æ–°å¢æ ¡å‡†æŒ‰é’®

        let containerWidth = sliderContainer.clientWidth;
        let currentValue = 0.500;
        let targetValue = 0.000;
        let timer = null;
        
        // ã€é›¶è¯¯å·®åŒ¹é…ã€‘TARGET_TOLERANCE è®¾ç½®ä¸º 0ï¼Œå¿…é¡»å®Œå…¨ç›¸ç­‰
        const TARGET_TOLERANCE = 0; 
        const HOLD_DURATION = 3000; 

        // ã€æé«˜çµæ•åº¦ã€‘MAX_TILT_ANGLE è®¾ç½®ä¸º 5 åº¦
        const MAX_TILT_ANGLE = 5; 
        const TILT_RANGE = 2 * MAX_TILT_ANGLE; 

        // ã€åŸºå‡†è§’ã€‘ç”¨äºæ ¡å‡†ï¼Œç¡®ä¿æ°´å¹³æ—¶ (gamma=0) æ˜ å°„ä½ç½®æ˜¯ 0.500
        let BASELINE_GAMMA = 0; 
        
        // ã€å¢å¼ºå¹³æ»‘ç³»æ•°ã€‘ä» 0.1 é™è‡³ 0.05ï¼Œè¿›ä¸€æ­¥å¢å¼ºç¨³å®šæ€§ã€‚
        const SMOOTHING_FACTOR = 0.05;
        let smoothedGamma = 0;

        let sensorActive = false;
        
        // æ ¸å¿ƒï¼šé€šè¿‡æ‰‹æœºå€¾æ–œè§’åº¦ (gamma) æ˜ å°„åˆ° 0 åˆ° 1 çš„ä½ç½®
        function mapAngleToPosition(gamma) {
            // 1. å‡å»åŸºå‡†è§’ï¼Œç¡®ä¿æ°´å¹³æ—¶ (gamma - BASELINE_GAMMA) = 0
            const relativeGamma = gamma - BASELINE_GAMMA;

            // 2. é™åˆ¶ç›¸å¯¹ gamma è§’åœ¨ [-5, 5] ä¹‹é—´ï¼Œé˜²æ­¢æ»‘å—æº¢å‡º
            const clampedGamma = Math.max(-MAX_TILT_ANGLE, Math.min(MAX_TILT_ANGLE, relativeGamma));
            
            // 3. æ˜ å°„é€»è¾‘ï¼šå°† [-5, 5] æ˜ å°„åˆ° [0, 1]
            let position = (clampedGamma + MAX_TILT_ANGLE) / TILT_RANGE;
            
            // 4. æœ€ç»ˆä¿é™©ï¼šç¡®ä¿ç»“æœåœ¨ 0 åˆ° 1 èŒƒå›´å†…
            return Math.max(0, Math.min(1, position)); 
        }

        // 1. åˆå§‹åŒ– - éšæœºç”Ÿæˆç›®æ ‡ä½ç½®
        function initializeTarget() {
            targetValue = (Math.random() * 0.8 + 0.1).toFixed(3);
            targetValue = parseFloat(targetValue);
            targetValueDisplay.textContent = targetValue.toFixed(3);
            
            containerWidth = sliderContainer.clientWidth; 
            const targetPosition = targetValue * containerWidth;
            targetMarker.style.left = targetPosition + 'px';
            
            currentValue = 0.500;
            updateHandlePosition(currentValue * containerWidth); 
            
            // åˆå§‹çŠ¶æ€åˆ¤æ–­æ˜¾ç¤ºä¿¡æ¯
            if (!sensorActive) {
                 verificationMessage.textContent = 'è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æˆæƒ';
            } else if (calibrateButton.style.display !== 'none') {
                 verificationMessage.textContent = 'è¯·å…ˆç‚¹å‡»æ ¡å‡†æŒ‰é’®';
            } else {
                 verificationMessage.textContent = 'è¯·æ‘‡æ™ƒæ‰‹æœºç§»åŠ¨æ»‘å—';
            }
            
            verificationMessage.className = 'message';
            clearTimeout(timer);
        }

        // 2. æ›´æ–°æ»‘å—ä½ç½®å’Œå½“å‰å€¼
        function updateHandlePosition(newX) {
            let x = Math.max(0, Math.min(containerWidth, newX));
            
            sliderHandle.style.left = x + 'px';
            
            currentValue = (x / containerWidth);
            currentValueDisplay.textContent = currentValue.toFixed(3); 
            
            if (sensorActive && calibrateButton.style.display === 'none') {
                checkVerificationStatus();
            }
        }

        // 3. éªŒè¯é€»è¾‘ (ä¸¥æ ¼ç­‰äºæ¯”è¾ƒ)
        function checkVerificationStatus() {
            // æ¯”è¾ƒ toFixed(3)åçš„å­—ç¬¦ä¸²å€¼ï¼Œå®ç°ä¸¥æ ¼åŒ¹é…
            const currentStr = currentValue.toFixed(3);
            const targetStr = targetValue.toFixed(3);
            
            if (currentStr === targetStr) {
                sliderHandle.style.backgroundColor = '#4CAF50'; 
                if (!timer) {
                    verificationMessage.textContent = 'ä½ç½®ç²¾ç¡®ï¼Œè¯·ä¿æŒ...';
                    timer = setTimeout(() => {
                        if (currentValue.toFixed(3) === targetValue.toFixed(3)) {
                            verificationSuccess();
                        } else {
                            resetTimerAndStatus('è¯·ä¿æŒç¨³å®š');
                        }
                    }, HOLD_DURATION);
                }
            } else {
                sliderHandle.style.backgroundColor = '#4a90e2';
                if (timer) {
                    resetTimerAndStatus('ä½ç½®åå·®è¿‡å¤§');
                }
            }
        }

        function resetTimerAndStatus(message) {
            clearTimeout(timer);
            timer = null;
            if (message) {
                verificationMessage.textContent = message;
                verificationMessage.className = 'message error';
            } else {
                initializeTarget();
            }
        }

        function verificationSuccess() {
            clearTimeout(timer);
            sensorActive = false; 
            window.removeEventListener('deviceorientation', handleDeviceOrientation);

            sliderHandle.style.backgroundColor = '#4CAF50';
            verificationMessage.textContent = 'âœ… éªŒè¯æˆåŠŸï¼åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹';
            verificationMessage.className = 'message success';
            permissionButton.style.display = 'none';
            calibrateButton.style.display = 'none';
        }
        
        // 4. é™€èºä»ª/æ–¹å‘ä¼ æ„Ÿå™¨å¤„ç†å‡½æ•° (å¹³æ»‘é€»è¾‘)
        function handleDeviceOrientation(event) {
            if (!sensorActive) return;
            
            const gamma = event.gamma; 
            
            if (gamma !== null) {
                // å¹³æ»‘å¤„ç†ï¼šå‡å°‘ä¼ æ„Ÿå™¨å™ªå£°å’ŒæŠ–åŠ¨
                smoothedGamma = smoothedGamma * (1 - SMOOTHING_FACTOR) + gamma * SMOOTHING_FACTOR;
                
                const mappedPosition = mapAngleToPosition(smoothedGamma);
                const newX = mappedPosition * containerWidth;
                updateHandlePosition(newX);
            }
        }

        // 5. æ ¡å‡†å‡½æ•° (æ–°å¢)
        function performCalibration() {
             // æ ¡å‡†æ—¶ï¼Œå°†å½“å‰çš„å¹³æ»‘åçš„ gamma å€¼è®¾ä¸ºåŸºå‡†çº¿
            if (smoothedGamma !== 0) {
                BASELINE_GAMMA = smoothedGamma;
                calibrateButton.style.display = 'none'; // æ ¡å‡†å®Œæˆåéšè—æŒ‰é’®
                initializeTarget(); // é‡æ–°åˆå§‹åŒ–éªŒè¯ç ç›®æ ‡
                verificationMessage.textContent = 'æ ¡å‡†å®Œæˆï¼Œè¯·æ‘‡æ™ƒæ‰‹æœºç§»åŠ¨æ»‘å—';
                verificationMessage.className = 'message';
            } else {
                verificationMessage.textContent = 'ä¼ æ„Ÿå™¨æ•°æ®å°šæœªå‡†å¤‡å¥½ï¼Œè¯·ç¨ç­‰...';
                verificationMessage.className = 'message error';
            }
        }

        // 6. æƒé™è¯·æ±‚å’Œå¯åŠ¨ä¼ æ„Ÿå™¨
        function requestSensorPermission() {
            permissionButton.disabled = true;
            
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startSensorListening();
                        } else {
                            permissionButton.disabled = false;
                            permissionButton.textContent = 'æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•';
                            verificationMessage.textContent = 'éœ€è¦è®¾å¤‡è¿åŠ¨æƒé™æ‰èƒ½ä½¿ç”¨æ‘‡æ™ƒåŠŸèƒ½';
                            verificationMessage.className = 'message error';
                        }
                    })
                    .catch(error => {
                        permissionButton.disabled = false;
                        permissionButton.textContent = 'æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•';
                        verificationMessage.textContent = 'æˆæƒè¯·æ±‚å¤±è´¥ (' + error.message + ')ã€‚è¯·ç¡®ä¿ä½¿ç”¨HTTPSæˆ–æœ¬åœ°ç¯å¢ƒã€‚';
                        verificationMessage.className = 'message error';
                    });
            } else {
                startSensorListening();
            }
        }

        function startSensorListening() {
            sensorActive = true;
            permissionButton.style.display = 'none'; // éšè—æƒé™æŒ‰é’®
            calibrateButton.style.display = 'block'; // æ˜¾ç¤ºæ ¡å‡†æŒ‰é’®
            
            window.addEventListener('deviceorientation', handleDeviceOrientation);
            
            verificationMessage.textContent = 'è¯·å…ˆå°†æ‰‹æœºæ°´å¹³æ”¾ç½®ï¼Œå¹¶ç‚¹å‡»æ ¡å‡†æŒ‰é’®';
            verificationMessage.className = 'message error';
        }

        // 7. äº‹ä»¶ç»‘å®šå’Œåˆå§‹åŒ–
        permissionButton.addEventListener('click', requestSensorPermission);
        calibrateButton.addEventListener('click', performCalibration); // ç»‘å®šæ ¡å‡†æŒ‰é’®äº‹ä»¶
        
        window.addEventListener('resize', () => {
            containerWidth = sliderContainer.clientWidth; 
            updateHandlePosition(currentValue * containerWidth);
            const targetPosition = targetValue * containerWidth;
            targetMarker.style.left = targetPosition + 'px';
        });

        initializeTarget();
        
        // åˆå§‹æ£€æŸ¥
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission !== 'function') {
            // Android æˆ–æ—§ç‰ˆæµè§ˆå™¨ï¼Œé»˜è®¤ç›´æ¥å¯åŠ¨ä¼ æ„Ÿå™¨
            permissionButton.style.display = 'none';
            startSensorListening();
            // åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ ¡å‡†å¯ä»¥é»˜è®¤æ‰§è¡Œä¸€æ¬¡
            if (smoothedGamma !== 0) {
                BASELINE_GAMMA = smoothedGamma;
            }
        } else if (typeof DeviceOrientationEvent === 'undefined') {
            // ä¸æ”¯æŒä¼ æ„Ÿå™¨
            permissionButton.disabled = true;
            permissionButton.textContent = 'è®¾å¤‡ä¸æ”¯æŒè¿åŠ¨ä¼ æ„Ÿå™¨';
            verificationMessage.textContent = 'æ‚¨çš„è®¾å¤‡/æµè§ˆå™¨ä¸æ”¯æŒè¿åŠ¨ä¼ æ„Ÿå™¨åŠŸèƒ½';
            verificationMessage.className = 'message error';
        }
    </script>

</body>
</html>
